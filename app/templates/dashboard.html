{% extends "base.html" %}

{% block title %}Dashboard - FlightTrack{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
        <p class="text-muted">Manage your flight tracking requests</p>
    </div>
</div>


<!-- Create New Request Form -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="bi bi-plus-circle"></i> Create New Search Request
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('dashboard.create') }}" id="searchForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.depart_from.label(class="form-label") }}
                            {{ form.depart_from(class="form-select" + (" is-invalid" if form.depart_from.errors else "")) }}
                            {% if form.depart_from.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.depart_from.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.arrive_at.label(class="form-label") }}
                            {{ form.arrive_at(class="form-select" + (" is-invalid" if form.arrive_at.errors else "")) }}
                            {% if form.arrive_at.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.arrive_at.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.departure_date.label(class="form-label") }}
                            {{ form.departure_date(class="form-control" + (" is-invalid" if form.departure_date.errors else "")) }}
                            {% if form.departure_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.departure_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3" id="returnDateGroup">
                            {{ form.return_date.label(class="form-label") }}
                            {{ form.return_date(class="form-control" + (" is-invalid" if form.return_date.errors else "")) }}
                            {% if form.return_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.return_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.passengers.label(class="form-label") }}
                            {{ form.passengers(class="form-control" + (" is-invalid" if form.passengers.errors else ""), type="number", min="1", max="9") }}
                            {% if form.passengers.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.passengers.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.trip_type.label(class="form-label") }}
                            <div>
                                {% for subfield in form.trip_type %}
                                    <div class="form-check form-check-inline">
                                        {{ subfield(class="form-check-input") }}
                                        {{ subfield.label(class="form-check-label") }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if form.trip_type.errors %}
                                <div class="text-danger small">
                                    {% for error in form.trip_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.preferred_airlines.label(class="form-label") }}
                            {{ form.preferred_airlines(class="form-select" + (" is-invalid" if form.preferred_airlines.errors else ""), size="5", multiple=True) }}
                            <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple airlines</small>
                            {% if form.preferred_airlines.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.preferred_airlines.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Existing Requests -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h4 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Your Search Requests
                </h4>
            </div>
            <div class="card-body">
                {% if requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Route</th>
                                    <th>Dates</th>
                                    <th>Passengers</th>
                                    <th>Trip Type</th>
                                    <th>Preferred Airlines</th>
                                    <th>Cheapest Price</th>
                                    <th>Last Search</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in requests %}
                                <tr>
                                    <td>
                                        <strong>{{ req.depart_from }}</strong> 
                                        <i class="bi bi-arrow-right"></i> 
                                        <strong>{{ req.arrive_at }}</strong>
                                    </td>
                                    <td>
                                        {{ req.departure_date }}
                                        {% if req.return_date %}
                                            <br><small class="text-muted">Return: {{ req.return_date }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ req.passengers }}</td>
                                    <td>
                                        <span class="badge bg-info">
                                            {{ 'Round Trip' if req.trip_type == 'round_trip' else 'One Way' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if req.preferred_airlines %}
                                            {% for airline in req.preferred_airlines %}
                                                <span class="badge bg-secondary">{{ airline }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">Any</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if req.price_tracking and req.price_tracking.minimum_price %}
                                            <strong class="text-success">${{ "%.2f"|format(req.price_tracking.minimum_price) }}</strong>
                                            {% if req.price_tracking.airlines %}
                                                <br><small class="text-muted">
                                                    {% for airline in req.price_tracking.airlines %}
                                                        {{ airline }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                </small>
                                            {% endif %}
                                            {% set link = req.price_tracking.flight_details.link if req.price_tracking.flight_details else None %}
                                            {% if link %}
                                                <br>
                                                <a href="{{ link }}" class="small" target="_blank" rel="noopener noreferrer">
                                                    Open flight
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Not searched yet</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if req.price_tracking and req.price_tracking.last_checked %}
                                            <small>{{ req.price_tracking.last_checked[:10] }}</small>
                                            <br><small class="text-muted">{{ req.price_tracking.last_checked[11:16] }}</small>
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('dashboard.search_flights_for_request', request_id=req.id) }}" 
                                              class="d-inline" 
                                              id="searchForm{{ req.id }}">
                                            <button type="submit" class="btn btn-sm btn-success mb-1" 
                                                    onclick="this.disabled=true; this.innerHTML='<i class=\'bi bi-hourglass-split\'></i> Searching...'; this.form.submit();">
                                                <i class="bi bi-search"></i> Search Flights
                                            </button>
                                        </form>
                                        <br>
                                        <a href="{{ url_for('dashboard.edit', request_id=req.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        <form method="POST" action="{{ url_for('dashboard.delete', request_id=req.id) }}" 
                                              class="d-inline" 
                                              onsubmit="return confirm('Are you sure you want to delete this request?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">No search requests yet. Create one above to get started!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Show/hide return date based on trip type
    document.addEventListener('DOMContentLoaded', function() {
        const tripTypeRadios = document.querySelectorAll('input[name="trip_type"]');
        const returnDateGroup = document.getElementById('returnDateGroup');
        const returnDateInput = document.querySelector('input[name="return_date"]');
        
        function toggleReturnDate() {
            const selectedTripType = document.querySelector('input[name="trip_type"]:checked').value;
            if (selectedTripType === 'one_way') {
                returnDateGroup.style.display = 'none';
                returnDateInput.value = '';
                returnDateInput.removeAttribute('required');
            } else {
                returnDateGroup.style.display = 'block';
                returnDateInput.setAttribute('required', 'required');
            }
        }
        
        // Set initial state
        toggleReturnDate();
        
        // Add event listeners
        tripTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleReturnDate);
        });
    });
</script>
{% endblock %}

