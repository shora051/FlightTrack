{% extends "base.html" %}

{% block title %}Dashboard - FlightTrack{% endblock %}

{% block content %}
<!-- Header -->
<div class="dashboard-header mb-5">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1 class="mb-2"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
            <p class="text-muted mb-0">Manage and track your flight search requests</p>
        </div>
        <div class="request-count-badge">
            <span class="badge bg-primary px-3 py-2 fs-6">
                {{ requests|length }} Request{{ 's' if requests|length != 1 else '' }}
            </span>
        </div>
    </div>
</div>

<!-- Create New Request Form -->
<div class="create-request-section mb-5">
    <div class="card shadow-lg border-0">
        <div class="card-header-modern">
            <div class="d-flex align-items-center">
                <div class="icon-wrapper me-3">
                    <i class="bi bi-plus-circle-fill"></i>
                </div>
                <div>
                    <h4 class="mb-0">Create New Search Request</h4>
                    <small class="text-muted">Add a new flight route to track</small>
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('dashboard.create') }}" id="searchForm">
                {{ form.hidden_tag() }}
                
                <!-- Route Selection -->
                <div class="form-section mb-4">
                    <h5 class="section-title mb-3"><i class="bi bi-route me-2"></i>Route</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.depart_from.label(class="form-label") }}
                            {{ form.depart_from(class="form-select form-select-lg" + (" is-invalid" if form.depart_from.errors else "")) }}
                            {% if form.depart_from.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.depart_from.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.arrive_at.label(class="form-label") }}
                            {{ form.arrive_at(class="form-select form-select-lg" + (" is-invalid" if form.arrive_at.errors else "")) }}
                            {% if form.arrive_at.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.arrive_at.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Dates -->
                <div class="form-section mb-4">
                    <h5 class="section-title mb-3"><i class="bi bi-calendar-event me-2"></i>Travel Dates</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.departure_date.label(class="form-label") }}
                            {{ form.departure_date(class="form-control form-control-lg" + (" is-invalid" if form.departure_date.errors else "")) }}
                            {% if form.departure_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.departure_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6" id="returnDateGroup">
                            {{ form.return_date.label(class="form-label") }}
                            {{ form.return_date(class="form-control form-control-lg" + (" is-invalid" if form.return_date.errors else "")) }}
                            {% if form.return_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.return_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Preferences -->
                <div class="form-section mb-4">
                    <h5 class="section-title mb-3"><i class="bi bi-gear me-2"></i>Preferences</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            {{ form.trip_type.label(class="form-label") }}
                            <div class="trip-type-buttons">
                                {% for subfield in form.trip_type %}
                                    <div class="form-check form-check-inline">
                                        {{ subfield(class="form-check-input") }}
                                        {{ subfield.label(class="form-check-label") }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if form.trip_type.errors %}
                                <div class="text-danger small mt-2">
                                    {% for error in form.trip_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form.stops.label(class="form-label") }}
                            {{ form.stops(class="form-select form-select-lg" + (" is-invalid" if form.stops.errors else "")) }}
                            {% if form.stops.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.stops.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form.preferred_airlines.label(class="form-label") }}
                            {{ form.preferred_airlines(class="form-select" + (" is-invalid" if form.preferred_airlines.errors else ""), size="5", multiple=True) }}
                            <small class="form-text text-muted d-block mt-1">Hold Ctrl/Cmd to select multiple</small>
                            {% if form.preferred_airlines.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.preferred_airlines.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Create Search Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Existing Requests -->
<div class="requests-section">
    <div class="section-header mb-4">
        <h2 class="mb-1"><i class="bi bi-list-check me-2"></i>Your Search Requests</h2>
        <p class="text-muted mb-0">Track and manage your saved flight searches</p>
    </div>
    
    {% if requests %}
        <div class="row g-4">
            {% for req in requests %}
            <div class="col-12">
                <div class="request-card card shadow-sm border-0 h-100">
                    <div class="card-body p-4">
                        <div class="row align-items-start">
                            <!-- Route & Main Info -->
                            <div class="col-lg-4 mb-3 mb-lg-0">
                                <div class="route-display mb-3">
                                    <div class="departure-city">
                                        <span class="city-code">{{ req.depart_from }}</span>
                                        <span class="city-label">Departure</span>
                                    </div>
                                    <div class="route-arrow">
                                        <i class="bi bi-arrow-right"></i>
                                    </div>
                                    <div class="arrival-city">
                                        <span class="city-code">{{ req.arrive_at }}</span>
                                        <span class="city-label">Arrival</span>
                                    </div>
                                </div>
                                <div class="trip-badge mb-2">
                                    <span class="badge bg-info">
                                        <i class="bi bi-{{ 'arrow-left-right' if req.trip_type == 'round_trip' else 'arrow-right' }} me-1"></i>
                                        {{ 'Round Trip' if req.trip_type == 'round_trip' else 'One Way' }}
                                    </span>
                                </div>
                                <div class="dates-info">
                                    <small class="text-muted d-block">
                                        <i class="bi bi-calendar3 me-1"></i>{{ req.departure_date }}
                                    </small>
                                    {% if req.return_date %}
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-calendar3 me-1"></i>Return: {{ req.return_date }}
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Preferences -->
                            <div class="col-lg-3 mb-3 mb-lg-0">
                                <div class="preferences-section">
                                    <div class="preference-item mb-2">
                                        <small class="text-muted d-block mb-1">Stops</small>
                                        {% if req.stops == 0 %}
                                            <span class="badge bg-secondary">Any stops</span>
                                        {% elif req.stops == 1 %}
                                            <span class="badge bg-success">Nonstop only</span>
                                        {% elif req.stops == 2 %}
                                            <span class="badge bg-warning">1 stop or fewer</span>
                                        {% elif req.stops == 3 %}
                                            <span class="badge bg-warning">2 stops or fewer</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Any stops</span>
                                        {% endif %}
                                    </div>
                                    <div class="preference-item">
                                        <small class="text-muted d-block mb-1">Airlines</small>
                                        {% if req.preferred_airlines %}
                                            <div class="airline-tags">
                                                {% for airline in req.preferred_airlines %}
                                                    <span class="badge bg-secondary me-1 mb-1">{{ airline }}</span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted small">Any airline</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price Tracking -->
                            <div class="col-lg-3 mb-3 mb-lg-0">
                                <div class="price-section">
                                    {% if req.price_tracking and req.price_tracking.minimum_price %}
                                        <div class="price-display mb-2">
                                            <small class="text-muted d-block mb-1">Cheapest Price</small>
                                            <div class="price-value text-success">
                                                <strong class="fs-4">${{ "%.2f"|format(req.price_tracking.minimum_price) }}</strong>
                                            </div>
                                            {% if req.price_tracking.airlines %}
                                                <small class="text-muted d-block mt-1">
                                                    {% for airline in req.price_tracking.airlines %}
                                                        {{ airline }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                </small>
                                            {% endif %}
                                            {% set link = req.price_tracking.flight_details.link if req.price_tracking.flight_details else None %}
                                            {% if link %}
                                                <a href="{{ link }}" class="btn btn-sm btn-outline-primary mt-2" target="_blank" rel="noopener noreferrer">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>View Flight
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="price-display">
                                            <small class="text-muted d-block mb-2">Cheapest Price</small>
                                            <span class="text-muted">Not searched yet</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="col-lg-2">
                                <div class="action-buttons d-flex flex-column gap-2">
                                    <a href="{{ url_for('dashboard.edit', request_id=req.id) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </a>
                                    <form method="POST" action="{{ url_for('dashboard.delete', request_id=req.id) }}" 
                                          class="d-inline" 
                                          onsubmit="return confirm('Are you sure you want to delete this request?');">
                                        <button type="submit" class="btn btn-outline-danger w-100">
                                            <i class="bi bi-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state card shadow-sm border-0">
            <div class="card-body text-center py-5">
                <div class="empty-icon mb-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                </div>
                <h4 class="mb-3">No search requests yet</h4>
                <p class="text-muted mb-4">Create your first flight search request above to start tracking prices!</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Show/hide return date based on trip type
    document.addEventListener('DOMContentLoaded', function() {
        const tripTypeRadios = document.querySelectorAll('input[name="trip_type"]');
        const returnDateGroup = document.getElementById('returnDateGroup');
        const returnDateInput = document.querySelector('input[name="return_date"]');
        
        function toggleReturnDate() {
            const selectedTripType = document.querySelector('input[name="trip_type"]:checked').value;
            if (selectedTripType === 'one_way') {
                returnDateGroup.style.display = 'none';
                returnDateInput.value = '';
                returnDateInput.removeAttribute('required');
            } else {
                returnDateGroup.style.display = 'block';
                returnDateInput.setAttribute('required', 'required');
            }
        }
        
        // Set initial state
        toggleReturnDate();
        
        // Add event listeners
        tripTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleReturnDate);
        });
    });
</script>
{% endblock %}

